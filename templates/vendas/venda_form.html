{% extends 'base.html' %}

{% block title %}{{ titulo }} - Gerencial SaaS{% endblock %}

{% block extra_css %}
<style>
    /* Estilos personalizados para modais */
    .modal-venda .modal-header {
        background-color: #343a40;
        color: white;
        border-radius: 0.25rem 0.25rem 0 0;
    }
    
    .modal-venda .modal-content {
        border: none;
        border-radius: 0.5rem;
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
    }
    
    .modal-venda .modal-footer {
        border-top: 1px solid #e3e6f0;
        background-color: #f8f9fc;
        border-radius: 0 0 0.25rem 0.25rem;
    }
    
    .list-group-item.list-group-item-action {
        transition: all 0.2s ease;
        border-left: 3px solid transparent;
    }
    
    .list-group-item.list-group-item-action:hover {
        background-color: #f8f9fc;
        border-left: 3px solid #4e73df;
    }
    
    .list-group-item.list-group-item-action strong {
        color: #4e73df;
        font-size: 0.9rem;
        text-transform: uppercase;
    }
    
    .list-group-item.text-muted {
        font-style: italic;
        background-color: #f8f9fc;
    }
    
    .modal-venda .form-control:focus {
        border-color: #bac8f3;
        box-shadow: 0 0 0 0.25rem rgba(78, 115, 223, 0.25);
    }
    
    .modal-venda .alerta-importante {
        background-color: #ff6b6b;
        color: white;
        font-weight: 600;
        font-size: 0.95rem;
        padding: 12px 16px;
        border-radius: 5px;
        border-left: 4px solid #e02020;
        margin-bottom: 1rem;
    }
    
    .modal-venda .btn-success {
        background-color: #1cc88a;
        border-color: #1cc88a;
    }
    
    .modal-venda .btn-success:hover {
        background-color: #17a673;
        border-color: #169b6b;
    }
    
    .modal-venda .btn-danger {
        background-color: #e74a3b;
        border-color: #e74a3b;
    }
    
    .modal-venda .btn-danger:hover {
        background-color: #be3e32;
        border-color: #b33b30;
    }
    
    .modal-venda .modal-instruction {
        color: #333;
        font-weight: 500;
        background-color: #f8f9ff;
        padding: 8px 12px;
        border-radius: 4px;
        margin-bottom: 15px;
        border-left: 3px solid #4e73df;
    }
    
    .modal-venda label.form-label {
        color: #333;
        font-weight: 600;
    }
    
    .modal-venda .form-text, 
    .modal-venda small.text-muted {
        color: #555 !important;
        font-weight: normal;
        font-size: 0.85rem;
    }
    
    .modal-venda .cliente-info {
        color: #333;
        font-weight: 600;
    }
    
    .modal-venda .cliente-nome {
        color: #3a3a3a;
        font-weight: 600;
        font-size: 1.1rem;
    }
    
    /* Animação suave ao abrir o modal */
    .modal.fade .modal-dialog {
        transition: transform 0.3s ease-out;
        transform: scale(0.95);
    }
    
    .modal.show .modal-dialog {
        transform: scale(1);
    }
    
    /* Estilos para as abas */
    .nav-tabs .nav-link {
        color: #555;
        font-weight: 500;
        padding: 0.8rem 1.2rem;
        border-radius: 0.5rem 0.5rem 0 0;
        transition: all 0.2s ease;
    }
    
    .nav-tabs .nav-link.active {
        color: #4e73df;
        font-weight: 600;
        border-bottom: 3px solid #4e73df;
        background-color: #f8fafc;
    }
    
    .nav-tabs .nav-link:hover:not(.active) {
        border-color: transparent;
        background-color: rgba(78, 115, 223, 0.05);
    }
    
    .tab-pane {
        padding: 1.5rem 0;
    }
    
    /* Estilos para cards nas abas */
    .tab-pane .card {
        transition: box-shadow 0.3s ease;
    }
    
    .tab-pane .card:hover {
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.1);
    }
    
    /* Estilos para botões de navegação */
    .card-footer {
        padding: 1rem;
    }
    
    /* Estilo para o formulário ativo */
    .tab-pane.active .card {
        border-color: #4e73df;
    }
    
    /* Estilo customizado para o dropdown de tipo de desconto */
    .input-group .dropdown-toggle {
        background: #23272b;
        color: #fff;
        border-left: none;
        border-radius: 0 0.375rem 0.375rem 0;
        box-shadow: none;
        transition: background 0.2s;
    }
    .input-group .dropdown-toggle:focus,
    .input-group .dropdown-toggle:hover {
        background: #4e73df;
        color: #fff;
    }
    .dropdown-menu.tipo-desconto-dropdown {
        min-width: 70px;
        background: #23272b;
        border: none;
        border-radius: 0.375rem;
        box-shadow: 0 0.5rem 1rem rgba(78, 115, 223, 0.10);
        padding: 0.25rem 0;
        left: auto !important;
        transform: none !important;
    }
    .dropdown-menu.tipo-desconto-dropdown .dropdown-item {
        color: #fff;
        background: transparent;
        font-weight: 500;
        text-align: center;
        border-radius: 0.375rem;
        margin: 2px 4px;
        padding: 4px 10px;
        transition: background 0.2s, color 0.2s;
        min-width: 30px;
        display: block;
        border: none !important;
        outline: none !important;
        box-shadow: none !important;
    }
    .dropdown-menu.tipo-desconto-dropdown .dropdown-item:hover,
    .dropdown-menu.tipo-desconto-dropdown .dropdown-item.active {
        background: #4e73df;
        color: #fff;
        border: none !important;
        outline: none !important;
        box-shadow: none !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'cliente_dashboard' %}">Dashboard</a></li>
            <li class="breadcrumb-item"><a href="{% url 'venda_lista' %}">Vendas</a></li>
            <li class="breadcrumb-item active" aria-current="page">{{ titulo }}</li>
        </ol>
    </nav>
    
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h2 mb-0 text-primary">{{ titulo }}</h1>
            <p class="text-muted">{{ subtitulo }}</p>
        </div>
        <a href="{% url 'venda_lista' %}" class="btn btn-outline-dark">
            <i class="fas fa-arrow-left me-2"></i>Voltar
        </a>
    </div>
    
    <div class="card shadow-sm border-0 mb-4">
        <div class="card-body p-4">
            <!-- Abas para as etapas do formulário -->
            <ul class="nav nav-tabs mb-4" id="vendaFormTab" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="cliente-tab" data-bs-toggle="tab" data-bs-target="#cliente" type="button" role="tab" aria-controls="cliente" aria-selected="true">
                        <i class="fas fa-user me-2"></i>Dados do Cliente
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="pagamento-tab" data-bs-toggle="tab" data-bs-target="#pagamento" type="button" role="tab" aria-controls="pagamento" aria-selected="false">
                        <i class="fas fa-money-bill-wave me-2"></i>Pagamento e Envio
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="produtos-tab" data-bs-toggle="tab" data-bs-target="#produtos" type="button" role="tab" aria-controls="produtos" aria-selected="false">
                        <i class="fas fa-box me-2"></i>Produtos
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="endereco-tab" data-bs-toggle="tab" data-bs-target="#endereco" type="button" role="tab" aria-controls="endereco" aria-selected="false">
                        <i class="fas fa-map-marker-alt me-2"></i>Endereço de Entrega
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="observacoes-tab" data-bs-toggle="tab" data-bs-target="#observacoes" type="button" role="tab" aria-controls="observacoes" aria-selected="false">
                        <i class="fas fa-sticky-note me-2"></i>Observações
                    </button>
                </li>
            </ul>
            
            <form method="post" id="vendaForm">
                {% csrf_token %}
                
                <div class="tab-content" id="vendaFormTabContent">
                    <!-- Aba Dados do Cliente -->
                    <div class="tab-pane fade show active" id="cliente" role="tabpanel" aria-labelledby="cliente-tab">
                        <div class="card h-100 bg-light border">
                            <div class="card-header bg-primary text-white">
                                <h5 class="card-title mb-0">Dados do Cliente</h5>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label for="cliente_id" class="form-label">Cliente Cadastrado</label>
                                    <select class="form-select" id="cliente_id" name="cliente_id">
                                        <option value="">Selecione um cliente ou informe os dados abaixo</option>
                                        {% for cliente in clientes %}
                                            <option value="{{ cliente.id }}">{{ cliente.nome }} ({{ cliente.email }})</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                
                                <div id="dados_cliente_manual">
                                    <div class="mb-3">
                                        <label for="cliente_nome" class="form-label">Nome do Cliente <span class="text-danger">*</span></label>
                                        <input type="text" class="form-control" id="cliente_nome" name="cliente_nome" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="cliente_email" class="form-label">E-mail do Cliente</label>
                                        <input type="email" class="form-control" id="cliente_email" name="cliente_email">
                                    </div>
                                    <div class="mb-3">
                                        <label for="cliente_telefone" class="form-label">Telefone do Cliente</label>
                                        <input type="text" class="form-control" id="cliente_telefone" name="cliente_telefone">
                                    </div>
                                </div>
                            </div>
                            <div class="card-footer bg-light">
                                <div class="d-flex justify-content-end">
                                    <button type="button" class="btn btn-primary" id="btn-prox-pagamento">
                                        Próximo <i class="fas fa-arrow-right ms-2"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Aba Pagamento e Envio -->
                    <div class="tab-pane fade" id="pagamento" role="tabpanel" aria-labelledby="pagamento-tab">
                        <div class="card h-100 bg-light border">
                            <div class="card-header bg-primary text-white">
                                <h5 class="card-title mb-0">Pagamento e Envio</h5>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label for="forma_pagamento" class="form-label">Forma de Pagamento</label>
                                    <select class="form-select" id="forma_pagamento" name="forma_pagamento" required>
                                        <option value="">Selecione uma forma de pagamento</option>
                                        {% for forma in formas_pagamento %}
                                            <option value="{{ forma.id }}">{{ forma.nome }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="metodo_envio" class="form-label">Método de Envio</label>
                                    <select class="form-select" id="metodo_envio" name="metodo_envio" required>
                                        <option value="">Selecione um método de envio</option>
                                        {% for metodo in metodos_envio %}
                                            <option value="{{ metodo.id }}" data-taxa="{{ metodo.taxa_fixa }}">
                                                {{ metodo.nome }} (R$ {{ metodo.taxa_fixa|floatformat:2 }})
                                            </option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            <div class="card-footer bg-light">
                                <div class="d-flex justify-content-between">
                                    <button type="button" class="btn btn-outline-secondary" id="btn-voltar-cliente">
                                        <i class="fas fa-arrow-left me-2"></i>Voltar
                                    </button>
                                    <button type="button" class="btn btn-primary" id="btn-prox-produtos">
                                        Próximo <i class="fas fa-arrow-right ms-2"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Aba Produtos -->
                    <div class="tab-pane fade" id="produtos" role="tabpanel" aria-labelledby="produtos-tab">
                        <div class="card h-100 bg-light border">
                            <div class="card-header bg-primary text-white">
                                <h5 class="card-title mb-0">Produtos</h5>
                            </div>
                            <div class="card-body">
                                <!-- Adicionar Produtos (agora no topo) -->
                                <div class="card shadow-sm border-0 mb-4">
                                    <div class="card-header bg-success text-white">
                                        <h5 class="card-title mb-0">Adicionar Produtos</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="row g-3">
                                            <div class="col-md-6">
                                                <label for="produto_id" class="form-label">Produto</label>
                                                <select class="form-select" id="produto_id" name="produto_id">
                                                    <option value="">Selecione um produto</option>
                                                    {% for produto in produtos %}
                                                        <option value="{{ produto.id }}" data-preco="{{ produto.preco }}" data-estoque="{{ produto.estoque }}">
                                                            {{ produto.nome }} (Estoque: {{ produto.estoque }})
                                                        </option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                            <div class="col-md-3">
                                                <label for="quantidade" class="form-label">Quantidade</label>
                                                <input type="number" class="form-control" id="quantidade" name="quantidade" min="1" value="1">
                                                <div id="estoqueDisponivel" class="form-text text-muted"></div>
                                            </div>
                                            <div class="col-md-3">
                                                <label for="valorUnitario" class="form-label">Valor Unitário</label>
                                                <div class="input-group">
                                                    <span class="input-group-text">R$</span>
                                                    <input type="text" class="form-control" id="valorUnitario" disabled>
                                                    <input type="hidden" id="valorUnitarioHidden" name="valor_unitario">
                                                </div>
                                            </div>
                                            <div class="col-12">
                                                <button type="button" class="btn btn-success" id="btn-adicionar-produto">
                                                    <i class="fas fa-plus-circle me-2"></i>Adicionar Produto
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <!-- Produtos Adicionados (no meio) -->
                                <div class="card shadow-sm border-0 mb-4">
                                    <div class="card-header bg-primary text-white">
                                        <h5 class="card-title mb-0">Produtos Adicionados</h5>
                                    </div>
                                    <div class="card-body p-0">
                                        <div class="table-responsive">
                                            <table class="table table-hover mb-0">
                                                <thead class="table-light">
                                                    <tr>
                                                        <th>Produto</th>
                                                        <th class="text-center">Quantidade</th>
                                                        <th class="text-end">Valor Unitário</th>
                                                        <th class="text-end">Valor Total</th>
                                                        <th class="text-center">Ações</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="lista-produtos">
                                                    <tr>
                                                        <td colspan="5" class="text-center py-3">
                                                            <div class="alert alert-warning mb-0">
                                                                Nenhum produto adicionado à venda. Adicione produtos abaixo.
                                                            </div>
                                                        </td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                                <!-- Resumo Financeiro (agora no final) -->
                                <div class="card shadow-sm border-0 mb-4">
                                    <div class="card-header bg-primary text-white">
                                        <h5 class="card-title mb-0">Resumo Financeiro</h5>
                                    </div>
                                    <div class="card-body">
                                        <ul class="list-group list-group-flush">
                                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                                <span>Subtotal:</span>
                                                <strong id="resumo-subtotal">R$ 0,00</strong>
                                            </li>
                                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                                <span>Desconto:</span>
                                                <strong class="text-danger" id="resumo-desconto">R$ 0,00</strong>
                                            </li>
                                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                                <span>Frete:</span>
                                                <strong id="resumo-frete">R$ 0,00</strong>
                                            </li>
                                            <li class="list-group-item d-flex justify-content-between align-items-center bg-light">
                                                <span class="fw-bold">Total:</span>
                                                <strong class="text-success fs-5" id="resumo-total">R$ 0,00</strong>
                                            </li>
                                        </ul>
                                        <!-- Aplicar Desconto -->
                                        <div class="mt-3">
                                            <div class="row g-3">
                                                <div class="col-md-6">
                                                    <div class="input-group">
                                                        <input type="number" class="form-control" name="desconto_valor" id="desconto_valor"
                                                               placeholder="Desconto" min="0" step="0.01" value="0">
                                                        <button class="btn btn-outline-secondary dropdown-toggle" type="button" id="tipoDescontoBtn" data-bs-toggle="dropdown" aria-expanded="false">
                                                            <span id="tipoDescontoLabel">%</span>
                                                        </button>
                                                        <ul class="dropdown-menu dropdown-menu-end tipo-desconto-dropdown" aria-labelledby="tipoDescontoBtn">
                                                            <li><a class="dropdown-item tipo-desconto-opcao" data-tipo="%">%</a></li>
                                                            <li><a class="dropdown-item tipo-desconto-opcao" data-tipo="R$">R$</a></li>
                                                        </ul>
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <button type="button" class="btn btn-outline-primary w-100" id="aplicar_desconto">
                                                        <i class="fas fa-percentage me-2"></i>Aplicar Desconto
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="card-footer bg-light">
                                <div class="d-flex justify-content-between">
                                    <button type="button" class="btn btn-outline-secondary" id="btn-voltar-pagamento">
                                        <i class="fas fa-arrow-left me-2"></i>Voltar
                                    </button>
                                    <button type="button" class="btn btn-primary" id="btn-prox-endereco">
                                        Próximo <i class="fas fa-arrow-right ms-2"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Aba Endereço de Entrega -->
                    <div class="tab-pane fade" id="endereco" role="tabpanel" aria-labelledby="endereco-tab">
                        <div class="card h-100 bg-light border">
                            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                                <h5 class="card-title mb-0">Endereço de Entrega</h5>
                                <div id="endereco-controles" style="display: none;">
                                    <button type="button" class="btn btn-sm btn-light" id="selecionar-endereco">
                                        <i class="fas fa-list me-1"></i> Selecionar Endereço
                                    </button>
                                    <button type="button" class="btn btn-sm btn-light" id="atualizar-endereco">
                                        <i class="fas fa-edit me-1"></i> Atualizar Endereço
                                    </button>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-8 mb-3">
                                        <label for="logradouro_entrega" class="form-label">Logradouro</label>
                                        <input type="text" class="form-control" id="logradouro_entrega" name="logradouro_entrega" required placeholder="Rua, Avenida, etc.">
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label for="numero_entrega" class="form-label">Número</label>
                                        <input type="text" class="form-control" id="numero_entrega" name="numero_entrega" required placeholder="Número">
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="cidade_entrega" class="form-label">Cidade</label>
                                        <input type="text" class="form-control" id="cidade_entrega" name="cidade_entrega" required>
                                    </div>
                                    <div class="col-md-3 mb-3">
                                        <label for="estado_entrega" class="form-label">Estado</label>
                                        <select class="form-select" id="estado_entrega" name="estado_entrega" required>
                                            <option value="">UF</option>
                                            <option value="AC">AC</option>
                                            <option value="AL">AL</option>
                                            <option value="AP">AP</option>
                                            <option value="AM">AM</option>
                                            <option value="BA">BA</option>
                                            <option value="CE">CE</option>
                                            <option value="DF">DF</option>
                                            <option value="ES">ES</option>
                                            <option value="GO">GO</option>
                                            <option value="MA">MA</option>
                                            <option value="MT">MT</option>
                                            <option value="MS">MS</option>
                                            <option value="MG">MG</option>
                                            <option value="PA">PA</option>
                                            <option value="PB">PB</option>
                                            <option value="PR">PR</option>
                                            <option value="PE">PE</option>
                                            <option value="PI">PI</option>
                                            <option value="RJ">RJ</option>
                                            <option value="RN">RN</option>
                                            <option value="RS">RS</option>
                                            <option value="RO">RO</option>
                                            <option value="RR">RR</option>
                                            <option value="SC">SC</option>
                                            <option value="SP">SP</option>
                                            <option value="SE">SE</option>
                                            <option value="TO">TO</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3 mb-3">
                                        <label for="cep_entrega" class="form-label">CEP</label>
                                        <input type="text" class="form-control" id="cep_entrega" name="cep_entrega" required placeholder="00000-000">
                                    </div>
                                </div>
                            </div>
                            <div class="card-footer bg-light">
                                <div class="d-flex justify-content-between">
                                    <button type="button" class="btn btn-outline-secondary" id="btn-voltar-produtos">
                                        <i class="fas fa-arrow-left me-2"></i>Voltar
                                    </button>
                                    <button type="button" class="btn btn-primary" id="btn-prox-observacoes">
                                        Próximo <i class="fas fa-arrow-right ms-2"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Aba Observações -->
                    <div class="tab-pane fade" id="observacoes" role="tabpanel" aria-labelledby="observacoes-tab">
                        <div class="card h-100 bg-light border">
                            <div class="card-header bg-primary text-white">
                                <h5 class="card-title mb-0">Observações</h5>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label for="observacoes" class="form-label">Observações Adicionais</label>
                                    <textarea class="form-control" id="observacoes" name="observacoes" rows="3"></textarea>
                                </div>
                            </div>
                            <div class="card-footer bg-light">
                                <div class="d-flex justify-content-between">
                                    <button type="button" class="btn btn-outline-secondary" id="btn-voltar-endereco">
                                        <i class="fas fa-arrow-left me-2"></i>Voltar
                                    </button>
                                    <div>
                                        <a href="{% url 'venda_lista' %}" class="btn btn-danger me-2">
                                            <i class="fas fa-times me-2"></i>Cancelar
                                        </a>
                                        <button type="submit" class="btn btn-success">
                                            <i class="fas fa-save me-2"></i>{{ botao }}
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal para seleção de endereços -->
<div class="modal fade modal-venda" id="selecionarEnderecoModal" tabindex="-1" aria-labelledby="selecionarEnderecoModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="selecionarEnderecoModalLabel">
                    <i class="fas fa-map-marker-alt me-2"></i>Selecionar Endereço
                </h5>
            </div>
            <div class="modal-body">
                <div class="modal-instruction">
                    <i class="fas fa-info-circle me-2"></i>Selecione um dos endereços cadastrados para este cliente:
                </div>
                <div class="list-group" id="lista-enderecos">
                    <!-- Endereços serão carregados via JavaScript -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>Fechar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para atualização de endereço -->
<div class="modal fade modal-venda" id="atualizarEnderecoModal" tabindex="-1" aria-labelledby="atualizarEnderecoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="atualizarEnderecoModalLabel">
                    <i class="fas fa-edit me-2"></i>Atualizar Endereços do Cliente
                </h5>
            </div>
            <div class="modal-body">
                <div class="mb-4">
                    <span class="cliente-info">Cliente:</span>
                    <p class="cliente-nome mt-1" id="cliente-nome-atualizar"></p>
                </div>
                
                <div class="row">
                    <div class="col-12 mb-3">
                        <h5 class="mb-3">Endereço Principal</h5>
                        <div class="row g-2">
                            <div class="col-md-8 mb-2">
                                <label for="principal-logradouro" class="form-label">Logradouro</label>
                                <input type="text" class="form-control" id="principal-logradouro" placeholder="Rua, Avenida, etc.">
                            </div>
                            <div class="col-md-4 mb-2">
                                <label for="principal-numero" class="form-label">Número</label>
                                <input type="text" class="form-control" id="principal-numero" placeholder="Número">
                            </div>
                            <div class="col-md-6 mb-2">
                                <label for="principal-bairro" class="form-label">Bairro</label>
                                <input type="text" class="form-control" id="principal-bairro" placeholder="Bairro">
                            </div>
                            <div class="col-md-6 mb-2">
                                <label for="principal-cidade" class="form-label">Cidade</label>
                                <input type="text" class="form-control" id="principal-cidade" placeholder="Cidade">
                            </div>
                            <div class="col-md-4 mb-2">
                                <label for="principal-estado" class="form-label">Estado</label>
                                <select class="form-select" id="principal-estado">
                                    <option value="">UF</option>
                                    <option value="AC">AC</option>
                                    <option value="AL">AL</option>
                                    <option value="AP">AP</option>
                                    <option value="AM">AM</option>
                                    <option value="BA">BA</option>
                                    <option value="CE">CE</option>
                                    <option value="DF">DF</option>
                                    <option value="ES">ES</option>
                                    <option value="GO">GO</option>
                                    <option value="MA">MA</option>
                                    <option value="MT">MT</option>
                                    <option value="MS">MS</option>
                                    <option value="MG">MG</option>
                                    <option value="PA">PA</option>
                                    <option value="PB">PB</option>
                                    <option value="PR">PR</option>
                                    <option value="PE">PE</option>
                                    <option value="PI">PI</option>
                                    <option value="RJ">RJ</option>
                                    <option value="RN">RN</option>
                                    <option value="RS">RS</option>
                                    <option value="RO">RO</option>
                                    <option value="RR">RR</option>
                                    <option value="SC">SC</option>
                                    <option value="SP">SP</option>
                                    <option value="SE">SE</option>
                                    <option value="TO">TO</option>
                                </select>
                            </div>
                            <div class="col-md-8 mb-2">
                                <label for="principal-cep" class="form-label">CEP</label>
                                <input type="text" class="form-control" id="principal-cep" placeholder="00000-000">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Remover os campos de texto único -->
                    <input type="hidden" id="endereco-principal">
                    <input type="hidden" id="endereco-secundario">
                    <input type="hidden" id="endereco-adicional">
                </div>
                
                <div class="alerta-importante">
                    <i class="fas fa-exclamation-circle me-2" style="color: #8B0000;"></i>
                    ATENÇÃO: Estas alterações serão salvas no cadastro do cliente e estarão disponíveis para futuras vendas.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>Cancelar
                </button>
                <button type="button" class="btn btn-success" id="salvar-enderecos">
                    <i class="fas fa-save me-2"></i>Salvar Endereços
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para cadastro de novo endereço -->
<div class="modal fade modal-venda" id="novoEnderecoModal" tabindex="-1" aria-labelledby="novoEnderecoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="novoEnderecoModalLabel">
                    <i class="fas fa-plus-circle me-2"></i>Adicionar Novo Endereço
                </h5>
            </div>
            <div class="modal-body">
                <div class="mb-4">
                    <span class="cliente-info">Cliente:</span>
                    <p class="cliente-nome mt-1" id="novo-endereco-cliente-nome"></p>
                </div>
                
                <form id="novo-endereco-form">
                    <div class="row g-3">
                        <div class="col-md-6 mb-3">
                            <label for="novo-endereco-tipo" class="form-label">Tipo de Endereço *</label>
                            <select class="form-select" id="novo-endereco-tipo" required>
                                <option value="">Selecione</option>
                                <option value="principal">Principal</option>
                                <option value="cobranca">Cobrança</option>
                                <option value="entrega">Entrega</option>
                                <option value="outro">Outro</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="novo-endereco-nome" class="form-label">Nome do Endereço</label>
                            <input type="text" class="form-control" id="novo-endereco-nome" placeholder="Ex: Casa, Trabalho">
                        </div>
                        
                        <div class="col-md-4 mb-3">
                            <label for="novo-endereco-cep" class="form-label">CEP *</label>
                            <input type="text" class="form-control" id="novo-endereco-cep" placeholder="00000-000" maxlength="9" required>
                            <small class="form-text text-muted">Digite o CEP para buscar o endereço</small>
                        </div>
                        
                        <div class="col-md-8 mb-3">
                            <label for="novo-endereco-logradouro" class="form-label">Logradouro *</label>
                            <input type="text" class="form-control" id="novo-endereco-logradouro" placeholder="Rua, Avenida, etc." required>
                        </div>
                        
                        <div class="col-md-4 mb-3">
                            <label for="novo-endereco-numero" class="form-label">Número *</label>
                            <input type="text" class="form-control" id="novo-endereco-numero" placeholder="Número" required>
                        </div>
                        
                        <div class="col-md-8 mb-3">
                            <label for="novo-endereco-complemento" class="form-label">Complemento</label>
                            <input type="text" class="form-control" id="novo-endereco-complemento" placeholder="Apto, Bloco, etc.">
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="novo-endereco-bairro" class="form-label">Bairro *</label>
                            <input type="text" class="form-control" id="novo-endereco-bairro" placeholder="Bairro" required>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="novo-endereco-cidade" class="form-label">Cidade *</label>
                            <input type="text" class="form-control" id="novo-endereco-cidade" placeholder="Cidade" required>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="novo-endereco-estado" class="form-label">Estado *</label>
                            <select class="form-select" id="novo-endereco-estado" required>
                                <option value="">Selecione</option>
                                <option value="AC">AC</option>
                                <option value="AL">AL</option>
                                <option value="AP">AP</option>
                                <option value="AM">AM</option>
                                <option value="BA">BA</option>
                                <option value="CE">CE</option>
                                <option value="DF">DF</option>
                                <option value="ES">ES</option>
                                <option value="GO">GO</option>
                                <option value="MA">MA</option>
                                <option value="MT">MT</option>
                                <option value="MS">MS</option>
                                <option value="MG">MG</option>
                                <option value="PA">PA</option>
                                <option value="PB">PB</option>
                                <option value="PR">PR</option>
                                <option value="PE">PE</option>
                                <option value="PI">PI</option>
                                <option value="RJ">RJ</option>
                                <option value="RN">RN</option>
                                <option value="RS">RS</option>
                                <option value="RO">RO</option>
                                <option value="RR">RR</option>
                                <option value="SC">SC</option>
                                <option value="SP">SP</option>
                                <option value="SE">SE</option>
                                <option value="TO">TO</option>
                            </select>
                        </div>
                    </div>
                </form>
                
                <div class="alert alert-info mt-3">
                    <i class="fas fa-info-circle me-2"></i>
                    Os endereços cadastrados estarão disponíveis para futuras vendas a este cliente.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>Cancelar
                </button>
                <button type="button" class="btn btn-success" id="salvar-novo-endereco">
                    <i class="fas fa-save me-2"></i>Salvar Endereço
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Elementos do formulário
        const clienteSelect = document.getElementById('cliente_id');
        const dadosClienteManual = document.getElementById('dados_cliente_manual');
        const clienteNome = document.getElementById('cliente_nome');
        const clienteEmail = document.getElementById('cliente_email');
        const clienteTelefone = document.getElementById('cliente_telefone');
        const logradouroEntrega = document.getElementById('logradouro_entrega');
        const numeroEntrega = document.getElementById('numero_entrega');
        const cidadeEntrega = document.getElementById('cidade_entrega');
        const estadoEntrega = document.getElementById('estado_entrega');
        const cepEntrega = document.getElementById('cep_entrega');
        const enderecoControles = document.getElementById('endereco-controles');
        const btnSelecionarEndereco = document.getElementById('selecionar-endereco');
        const btnAtualizarEndereco = document.getElementById('atualizar-endereco');
        const listaEnderecos = document.getElementById('lista-enderecos');

        // Botões de navegação entre abas
        const btnProxPagamento = document.getElementById('btn-prox-pagamento');
        const btnVoltarCliente = document.getElementById('btn-voltar-cliente');
        const btnProxProdutos = document.getElementById('btn-prox-produtos');
        const btnVoltarPagamento = document.getElementById('btn-voltar-pagamento');
        const btnProxEndereco = document.getElementById('btn-prox-endereco');
        const btnVoltarProdutos = document.getElementById('btn-voltar-produtos');
        const btnProxObservacoes = document.getElementById('btn-prox-observacoes');
        const btnVoltarEndereco = document.getElementById('btn-voltar-endereco');

        // Abas
        const tabCliente = new bootstrap.Tab(document.querySelector('#cliente-tab'));
        const tabPagamento = new bootstrap.Tab(document.querySelector('#pagamento-tab'));
        const tabProdutos = new bootstrap.Tab(document.querySelector('#produtos-tab'));
        const tabEndereco = new bootstrap.Tab(document.querySelector('#endereco-tab'));
        const tabObservacoes = new bootstrap.Tab(document.querySelector('#observacoes-tab'));

        // Produtos
        const produtoSelect = document.getElementById('produto_id');
        const quantidadeInput = document.getElementById('quantidade');
        const valorUnitarioInput = document.getElementById('valorUnitario');
        const valorUnitarioHidden = document.getElementById('valorUnitarioHidden');
        const estoqueDisponivel = document.getElementById('estoqueDisponivel');
        const btnAdicionarProduto = document.getElementById('btn-adicionar-produto');
        const listaProdutos = document.getElementById('lista-produtos');
        const resumoSubtotal = document.getElementById('resumo-subtotal');
        const resumoDesconto = document.getElementById('resumo-desconto');
        const resumoFrete = document.getElementById('resumo-frete');
        const resumoTotal = document.getElementById('resumo-total');
        const descontoPercentualInput = document.getElementById('desconto_valor');
        const aplicarDescontoBtn = document.getElementById('aplicar_desconto');
        const metodoEnvioSelect = document.getElementById('metodo_envio');
        const formaPagamentoSelect = document.getElementById('forma_pagamento');

        // Variáveis de controle
        let produtosAdicionados = [];
        let subtotal = 0;
        let descontoPercentual = 0;
        let descontoValor = 0;
        let valorFrete = 0;
        let valorTotal = 0;
        let tipoDesconto = '%'; // '%' ou 'R$'

        // --- MODAIS DE ENDEREÇO ---
        const selecionarEnderecoModalEl = document.getElementById('selecionarEnderecoModal');
        const atualizarEnderecoModalEl = document.getElementById('atualizarEnderecoModal');
        const novoEnderecoModalEl = document.getElementById('novoEnderecoModal');
        let selecionarEnderecoModal = null;
        let atualizarEnderecoModal = null;
        let novoEnderecoModal = null;
        if (typeof bootstrap !== 'undefined') {
            selecionarEnderecoModal = new bootstrap.Modal(selecionarEnderecoModalEl);
            atualizarEnderecoModal = new bootstrap.Modal(atualizarEnderecoModalEl);
            novoEnderecoModal = new bootstrap.Modal(novoEnderecoModalEl);
        }

        // Função para carregar e exibir endereços no modal de seleção
        function abrirModalSelecionarEndereco() {
            listaEnderecos.innerHTML = '<div class="text-center text-muted py-3">Carregando endereços...</div>';
            const clienteId = clienteSelect.value;
            if (!clienteId) {
                listaEnderecos.innerHTML = '<div class="alert alert-warning">Selecione um cliente cadastrado para ver os endereços.</div>';
                return;
            }
            fetch(`/vendas/cliente/${clienteId}/dados/`)
                .then(response => response.json())
                .then(data => {
                    console.log('Resposta obter_dados_cliente:', data);
                    if (!data.success) {
                        listaEnderecos.innerHTML = `<div class='alert alert-danger'>${data.message || 'Erro ao buscar endereços do cliente.'}</div>`;
                        return;
                    }
                    listaEnderecos.innerHTML = '';
                    if (data.enderecos && data.enderecos.length > 0) {
                        let hasActivePrincipal = false;
                        data.enderecos.forEach((endereco, index) => {
                            const isPrincipal = endereco.tipo === 'principal';
                            if (isPrincipal) hasActivePrincipal = true;
                            
                            const div = document.createElement('div');
                            div.className = 'list-group-item list-group-item-action d-flex justify-content-between align-items-center';
                            if (isPrincipal) div.classList.add('active', 'bg-primary');
                            
                            div.innerHTML = `
                                <div>
                                    <strong>${endereco.nome}</strong> ${isPrincipal ? '<span class="badge bg-light text-dark">Principal</span>' : ''}
                                    <br>
                                    <span class="${isPrincipal ? 'text-white' : 'text-primary'}">${endereco.logradouro || ''}, ${endereco.numero || ''}</span>
                                    <br>
                                    <small class="${isPrincipal ? 'text-light' : 'text-muted'}">${endereco.cidade || ''} - ${endereco.estado || ''}, ${endereco.cep || ''}</small>
                                </div>
                                <button type="button" class="btn btn-sm ${isPrincipal ? 'btn-light' : 'btn-primary'} btn-usar-endereco" data-index="${index}">
                                    Usar este endereço
                                </button>
                            `;
                            listaEnderecos.appendChild(div);
                        });
                        
                        // Adicionar botão para adicionar novo endereço
                        if (data.enderecos.length < 3) {
                            const addDiv = document.createElement('div');
                            addDiv.className = 'list-group-item list-group-item-action text-center';
                            addDiv.innerHTML = `
                                <button type="button" class="btn btn-success btn-sm" id="btn-add-novo-endereco">
                                    <i class="fas fa-plus-circle me-1"></i> Adicionar Novo Endereço
                                </button>
                            `;
                            listaEnderecos.appendChild(addDiv);
                            
                            // Adicionar evento para o botão de adicionar endereço
                            document.getElementById('btn-add-novo-endereco').addEventListener('click', function() {
                                selecionarEnderecoModal.hide();
                                abrirModalCadastrarEndereco();
                            });
                        }
                        
                        // Evento para selecionar endereço
                        document.querySelectorAll('.btn-usar-endereco').forEach(btn => {
                            btn.addEventListener('click', function() {
                                const idx = parseInt(this.getAttribute('data-index'));
                                const endereco = data.enderecos[idx];
                                if (endereco) {
                                    preencherEnderecoEntrega(endereco);
                                    selecionarEnderecoModal.hide();
                                } else {
                                    console.error('Endereço não encontrado no índice:', idx);
                                }
                            });
                        });
                    } else {
                        // Nenhum endereço encontrado
                        listaEnderecos.innerHTML = `
                            <div class="list-group-item text-center text-muted py-3">
                                <p class="mb-2"><i class="fas fa-map-marker-alt fa-2x mb-2"></i></p>
                                <p>Nenhum endereço cadastrado para este cliente.</p>
                                <button type="button" class="btn btn-primary btn-sm" id="btn-add-primeiro-endereco">
                                    <i class="fas fa-plus-circle me-1"></i> Adicionar Endereço
                                </button>
                            </div>
                        `;
                        
                        // Adicionar evento para o botão de adicionar primeiro endereço
                        document.getElementById('btn-add-primeiro-endereco').addEventListener('click', function() {
                            selecionarEnderecoModal.hide();
                            abrirModalCadastrarEndereco();
                        });
                    }
                })
                .catch(error => {
                    console.error('Erro ao buscar endereços do cliente:', error);
                    listaEnderecos.innerHTML = '<div class="alert alert-danger">Erro ao buscar endereços do cliente.</div>';
                });
        }

        // Função para abrir modal de atualização de endereço
        function abrirModalAtualizarEndereco() {
            const clienteId = clienteSelect.value;
            if (!clienteId) {
                alert('Selecione um cliente cadastrado para atualizar endereços.');
                return;
            }
            // Preencher nome do cliente
            document.getElementById('cliente-nome-atualizar').textContent = clienteSelect.options[clienteSelect.selectedIndex].text;
            // Carregar endereços existentes
            fetch(`/vendas/cliente/${clienteId}/dados/`)
                .then(response => response.json())
                .then(data => {
                    if (data.enderecos && data.enderecos.length > 0) {
                        const enderecoPrincipal = data.enderecos[0];
                        document.getElementById('principal-logradouro').value = enderecoPrincipal.logradouro || '';
                        document.getElementById('principal-numero').value = enderecoPrincipal.numero || '';
                        document.getElementById('principal-bairro').value = enderecoPrincipal.bairro || '';
                        document.getElementById('principal-cidade').value = enderecoPrincipal.cidade || '';
                        document.getElementById('principal-estado').value = enderecoPrincipal.estado || '';
                        document.getElementById('principal-cep').value = enderecoPrincipal.cep || '';
                    }
                });
            atualizarEnderecoModal.show();
        }

        // Evento para salvar endereços atualizados
        const salvarEnderecosBtn = document.getElementById('salvar-enderecos');
        if (salvarEnderecosBtn) {
            salvarEnderecosBtn.addEventListener('click', function() {
                const clienteId = clienteSelect.value;
                if (!clienteId) {
                    alert('Selecione um cliente válido para atualizar endereços.');
                    return;
                }
                
                // Montar texto compatível do endereço principal
                const logradouro = document.getElementById('principal-logradouro').value.trim();
                const numero = document.getElementById('principal-numero').value.trim();
                const bairro = document.getElementById('principal-bairro').value.trim();
                const cidade = document.getElementById('principal-cidade').value.trim();
                const estado = document.getElementById('principal-estado').value.trim();
                const cep = document.getElementById('principal-cep').value.trim();
                
                // Formatação para compatibilidade com código antigo
                const enderecoPrincipal = `${logradouro}, ${numero}, ${bairro}, ${cidade} - ${estado}, ${cep}`;
                
                fetch('/vendas/cliente/atualizar-enderecos/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    },
                    body: JSON.stringify({
                        cliente_id: clienteId,
                        endereco_principal: enderecoPrincipal,
                        endereco_secundario: '', // Removemos os outros endereços por simplicidade
                        endereco_adicional: ''
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Endereços atualizados com sucesso!');
                        atualizarEnderecoModal.hide();
                        // Atualizar campos do formulário com o novo principal
                        if (logradouro) {
                            preencherEnderecoEntrega({
                                logradouro: logradouro,
                                numero: numero,
                                bairro: bairro,
                                cidade: cidade,
                                estado: estado,
                                cep: cep
                            });
                        }
                    } else {
                        alert('Erro ao atualizar endereços: ' + (data.message || 'Erro desconhecido.'));
                    }
                })
                .catch(error => {
                    alert('Erro ao atualizar endereços: ' + error);
                });
            });
        }

        // Listeners dos botões
        if (btnSelecionarEndereco) btnSelecionarEndereco.addEventListener('click', function(e) {
            e.preventDefault();
            const clienteId = clienteSelect.value;
            if (!clienteId || isNaN(clienteId) || parseInt(clienteId) <= 0) {
                listaEnderecos.innerHTML = '<div class="alert alert-warning">Selecione um cliente válido para ver os endereços.</div>';
                selecionarEnderecoModal.show();
                return;
            }
            abrirModalSelecionarEndereco();
            selecionarEnderecoModal.show();
        });
        if (btnAtualizarEndereco) btnAtualizarEndereco.addEventListener('click', function(e) {
            e.preventDefault();
            abrirModalAtualizarEndereco();
        });

        // --- Funções Auxiliares ---
        function toggleClienteFields() {
            if (clienteSelect.value) {
                dadosClienteManual.style.display = 'none';
                clienteNome.removeAttribute('required');
                enderecoControles.style.display = 'block';
                carregarDadosCliente(clienteSelect.value);
            } else {
                dadosClienteManual.style.display = 'block';
                clienteNome.setAttribute('required', '');
                enderecoControles.style.display = 'none';
                clienteEmail.value = '';
                clienteTelefone.value = '';
                logradouroEntrega.value = '';
                numeroEntrega.value = '';
                cidadeEntrega.value = '';
                estadoEntrega.value = '';
                cepEntrega.value = '';
            }
        }

        function carregarDadosCliente(clienteId) {
            fetch(`/vendas/cliente/${clienteId}/dados/`)
                .then(response => response.json())
                .then(data => {
                    console.log('Dados do cliente carregados:', data);
                    clienteEmail.value = data.email || '';
                    clienteTelefone.value = data.telefone || '';
                    if (data.enderecos && data.enderecos.length > 0) {
                        preencherEnderecoEntrega(data.enderecos[0]);
                    }
                })
                .catch(error => {
                    console.error('Erro ao carregar dados do cliente:', error);
                });
        }

        function preencherEnderecoEntrega(endereco) {
            console.log('Preenchendo endereço com:', endereco);
            // Dados separados do endereço
            logradouroEntrega.value = endereco.logradouro || endereco.rua || '';
            numeroEntrega.value = endereco.numero || '';
            cidadeEntrega.value = endereco.cidade || '';
            estadoEntrega.value = endereco.estado || '';
            cepEntrega.value = endereco.cep || '';
            console.log('Campos preenchidos:', {
                logradouro: logradouroEntrega.value,
                numero: numeroEntrega.value,
                cidade: cidadeEntrega.value,
                estado: estadoEntrega.value,
                cep: cepEntrega.value
            });
        }

        function atualizarProdutoInfo() {
            if (produtoSelect && produtoSelect.selectedIndex > 0) {
                const option = produtoSelect.options[produtoSelect.selectedIndex];
                const preco = option.dataset.preco;
                const estoque = option.dataset.estoque;
                valorUnitarioInput.value = parseFloat(preco).toFixed(2).replace('.', ',');
                valorUnitarioHidden.value = preco;
                estoqueDisponivel.innerHTML = `Disponível: ${estoque} unidade(s)`;
                quantidadeInput.max = estoque;
                if (parseInt(quantidadeInput.value) > parseInt(estoque)) {
                    quantidadeInput.value = estoque;
                }
            } else {
                valorUnitarioInput.value = '';
                valorUnitarioHidden.value = '';
                estoqueDisponivel.innerHTML = '';
            }
        }

        function atualizarResumoFinanceiro() {
            subtotal = produtosAdicionados.reduce((total, produto) => total + (produto.valorUnitario * produto.quantidade), 0);
            let descontoInput = parseFloat(document.getElementById('desconto_valor').value) || 0;
            if (tipoDesconto === '%') {
                descontoPercentual = descontoInput;
                descontoValor = subtotal * (descontoPercentual / 100);
            } else {
                descontoPercentual = 0;
                descontoValor = descontoInput;
            }
            valorFrete = 0;
            if (metodoEnvioSelect && metodoEnvioSelect.selectedIndex > 0) {
                const option = metodoEnvioSelect.options[metodoEnvioSelect.selectedIndex];
                valorFrete = parseFloat(option.dataset.taxa || 0);
            }
            valorTotal = subtotal - descontoValor + valorFrete;
            resumoSubtotal.textContent = `R$ ${subtotal.toFixed(2)}`;
            resumoDesconto.textContent = `R$ ${descontoValor.toFixed(2)}`;
            resumoFrete.textContent = `R$ ${valorFrete.toFixed(2)}`;
            resumoTotal.textContent = `R$ ${valorTotal.toFixed(2)}`;
            adicionarCamposOcultos();
        }

        function adicionarCamposOcultos() {
            document.querySelectorAll('.campo-oculto-venda').forEach(campo => campo.remove());
            adicionarCampoOculto('subtotal', subtotal.toFixed(2));
            adicionarCampoOculto('desconto_percentual', descontoPercentual.toFixed(2));
            adicionarCampoOculto('desconto_valor', descontoValor.toFixed(2));
            adicionarCampoOculto('valor_frete', valorFrete.toFixed(2));
            adicionarCampoOculto('valor_total', valorTotal.toFixed(2));
            produtosAdicionados.forEach((produto, index) => {
                adicionarCampoOculto(`produtos[${index}][id]`, produto.id);
                adicionarCampoOculto(`produtos[${index}][quantidade]`, produto.quantidade);
                adicionarCampoOculto(`produtos[${index}][valor_unitario]`, produto.valorUnitario.toFixed(2));
            });
        }
        function adicionarCampoOculto(nome, valor) {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = nome;
            input.value = valor;
            input.className = 'campo-oculto-venda';
            document.getElementById('vendaForm').appendChild(input);
        }

        function adicionarProduto() {
            if (!produtoSelect || produtoSelect.selectedIndex <= 0) {
                alert('Por favor, selecione um produto');
                return;
            }
            const option = produtoSelect.options[produtoSelect.selectedIndex];
            const produtoId = produtoSelect.value;
            const produtoNome = option.text.split(' (Estoque:')[0];
            const valorUnitario = parseFloat(option.dataset.preco);
            const quantidade = parseInt(quantidadeInput.value);
            const estoque = parseInt(option.dataset.estoque);
            if (quantidade <= 0) {
                alert('A quantidade deve ser maior que zero');
                return;
            }
            if (quantidade > estoque) {
                alert(`Estoque insuficiente. Disponível: ${estoque}`);
                return;
            }
            const produtoExistente = produtosAdicionados.findIndex(p => p.id === produtoId);
            if (produtoExistente >= 0) {
                produtosAdicionados[produtoExistente].quantidade += quantidade;
                if (produtosAdicionados[produtoExistente].quantidade > estoque) {
                    alert(`Quantidade total excede o estoque disponível (${estoque})`);
                    produtosAdicionados[produtoExistente].quantidade -= quantidade;
                    return;
                }
            } else {
                produtosAdicionados.push({
                    id: produtoId,
                    nome: produtoNome,
                    valorUnitario: valorUnitario,
                    quantidade: quantidade
                });
            }
            atualizarListaProdutos();
            atualizarResumoFinanceiro();
            produtoSelect.selectedIndex = 0;
            quantidadeInput.value = 1;
            atualizarProdutoInfo();
        }

        function atualizarListaProdutos() {
            listaProdutos.innerHTML = '';
            if (produtosAdicionados.length === 0) {
                listaProdutos.innerHTML = `
                    <tr>
                        <td colspan="5" class="text-center py-3">
                            <div class="alert alert-warning mb-0">
                                Nenhum produto adicionado à venda. Adicione produtos abaixo.
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }
            produtosAdicionados.forEach((produto, index) => {
                const valorTotal = produto.valorUnitario * produto.quantidade;
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${produto.nome}</td>
                    <td class="text-center">${produto.quantidade}</td>
                    <td class="text-end">R$ ${produto.valorUnitario.toFixed(2)}</td>
                    <td class="text-end">R$ ${valorTotal.toFixed(2)}</td>
                    <td class="text-center">
                        <button type="button" class="btn btn-sm btn-outline-danger btn-remover-produto" data-index="${index}">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </td>
                `;
                listaProdutos.appendChild(row);
            });
            document.querySelectorAll('.btn-remover-produto').forEach(btn => {
                btn.addEventListener('click', function() {
                    const index = parseInt(this.dataset.index);
                    removerProduto(index);
                });
            });
        }
        function removerProduto(index) {
            if (index >= 0 && index < produtosAdicionados.length) {
                produtosAdicionados.splice(index, 1);
                atualizarListaProdutos();
                atualizarResumoFinanceiro();
            }
        }

        // --- Listeners ---
        clienteSelect.addEventListener('change', toggleClienteFields);
        if (btnProxPagamento) btnProxPagamento.addEventListener('click', function(e) {
            e.preventDefault();
            if (!clienteSelect.value && !clienteNome.value) {
                alert('Selecione um cliente ou informe o nome do cliente');
                return;
            }
            tabPagamento.show();
        });
        if (btnVoltarCliente) btnVoltarCliente.addEventListener('click', function(e) {
            e.preventDefault();
            tabCliente.show();
        });
        if (btnProxProdutos) btnProxProdutos.addEventListener('click', function(e) {
            e.preventDefault();
            if (!formaPagamentoSelect.value) {
                alert('Selecione um método de pagamento');
                return;
            }
            if (!metodoEnvioSelect.value) {
                alert('Selecione um método de envio');
                return;
            }
            tabProdutos.show();
        });
        if (btnVoltarPagamento) btnVoltarPagamento.addEventListener('click', function(e) {
            e.preventDefault();
            tabPagamento.show();
        });
        if (btnProxEndereco) btnProxEndereco.addEventListener('click', function(e) {
            e.preventDefault();
            if (produtosAdicionados.length === 0) {
                alert('Adicione pelo menos um produto à venda');
                return;
            }
            tabEndereco.show();
        });
        if (btnVoltarProdutos) btnVoltarProdutos.addEventListener('click', function(e) {
            e.preventDefault();
            tabProdutos.show();
        });
        if (btnProxObservacoes) btnProxObservacoes.addEventListener('click', function(e) {
            e.preventDefault();
            const metodoEnvioText = metodoEnvioSelect.options[metodoEnvioSelect.selectedIndex]?.text || '';
            const isPresencial = metodoEnvioText.includes('Presencial');
            if (!isPresencial) {
                if (!logradouroEntrega.value || !cidadeEntrega.value || !estadoEntrega.value || !cepEntrega.value) {
                    alert('Preencha todos os campos de endereço para envio');
                    return;
                }
            }
            tabObservacoes.show();
        });
        if (btnVoltarEndereco) btnVoltarEndereco.addEventListener('click', function(e) {
            e.preventDefault();
            tabEndereco.show();
        });
        if (produtoSelect) produtoSelect.addEventListener('change', atualizarProdutoInfo);
        if (btnAdicionarProduto) btnAdicionarProduto.addEventListener('click', function(e) {
            e.preventDefault();
            adicionarProduto();
        });
        if (aplicarDescontoBtn) aplicarDescontoBtn.addEventListener('click', function(e) {
            e.preventDefault();
            let descontoInput = parseFloat(document.getElementById('desconto_valor').value);
            if (isNaN(descontoInput) || descontoInput < 0) {
                alert('Informe um valor de desconto válido');
                return;
            }
            if (tipoDesconto === '%' && (descontoInput < 0 || descontoInput > 100)) {
                alert('Informe um percentual de desconto válido (entre 0 e 100)');
                return;
            }
            atualizarResumoFinanceiro();
        });
        if (metodoEnvioSelect) metodoEnvioSelect.addEventListener('change', atualizarResumoFinanceiro);
        // Dropdown do tipo de desconto
        const tipoDescontoBtn = document.getElementById('tipoDescontoBtn');
        const tipoDescontoLabel = document.getElementById('tipoDescontoLabel');
        document.querySelectorAll('.tipo-desconto-opcao').forEach(function(item) {
            item.addEventListener('click', function() {
                tipoDesconto = this.getAttribute('data-tipo');
                tipoDescontoLabel.textContent = tipoDesconto;
                atualizarResumoFinanceiro();
            });
        });
        // Inicialização
        toggleClienteFields();
        atualizarProdutoInfo();
        atualizarListaProdutos();
        atualizarResumoFinanceiro();

        // Função para abrir modal de cadastro de novo endereço
        function abrirModalCadastrarEndereco() {
            const clienteId = clienteSelect.value;
            if (!clienteId) {
                alert('Selecione um cliente cadastrado para adicionar endereços.');
                return;
            }
            
            // Configurar modal para cadastro de novo endereço
            document.getElementById('novo-endereco-cliente-nome').textContent = clienteSelect.options[clienteSelect.selectedIndex].text;
            document.getElementById('novo-endereco-form').reset();
            
            // Mostrar o modal
            novoEnderecoModal.show();
        }

        // Evento para salvar novo endereço
        const salvarNovoEnderecoBtn = document.getElementById('salvar-novo-endereco');
        if (salvarNovoEnderecoBtn) {
            salvarNovoEnderecoBtn.addEventListener('click', function() {
                const clienteId = clienteSelect.value;
                if (!clienteId) {
                    alert('Selecione um cliente válido para adicionar endereço.');
                    return;
                }
                
                // Validar campos obrigatórios
                const tipo = document.getElementById('novo-endereco-tipo').value;
                const logradouro = document.getElementById('novo-endereco-logradouro').value.trim();
                const numero = document.getElementById('novo-endereco-numero').value.trim();
                const bairro = document.getElementById('novo-endereco-bairro').value.trim();
                const cidade = document.getElementById('novo-endereco-cidade').value.trim();
                const estado = document.getElementById('novo-endereco-estado').value;
                const cep = document.getElementById('novo-endereco-cep').value.trim();
                const nome = document.getElementById('novo-endereco-nome').value.trim();
                
                if (!tipo || !logradouro || !numero || !bairro || !cidade || !estado || !cep) {
                    alert('Por favor, preencha todos os campos obrigatórios.');
                    return;
                }
                
                // Validar CEP
                if (!cep.match(/^\d{5}-?\d{3}$/)) {
                    alert('O CEP deve estar no formato 00000-000.');
                    return;
                }
                
                // Enviar dados para o servidor
                fetch('/vendas/cliente/atualizar-enderecos/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    },
                    body: JSON.stringify({
                        cliente_id: clienteId,
                        enderecos: [{
                            tipo: tipo,
                            nome: nome || `Endereço ${tipo}`,
                            logradouro: logradouro,
                            numero: numero,
                            complemento: document.getElementById('novo-endereco-complemento').value.trim(),
                            bairro: bairro,
                            cidade: cidade,
                            estado: estado,
                            cep: cep
                        }]
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Endereço adicionado com sucesso!');
                        novoEnderecoModal.hide();
                        
                        // Se for endereço principal, popular os campos automaticamente
                        if (tipo === 'principal') {
                            preencherEnderecoEntrega({
                                logradouro: logradouro,
                                numero: numero,
                                bairro: bairro,
                                cidade: cidade,
                                estado: estado,
                                cep: cep
                            });
                        }
                    } else {
                        alert('Erro ao adicionar endereço: ' + (data.message || 'Erro desconhecido.'));
                    }
                })
                .catch(error => {
                    alert('Erro ao adicionar endereço: ' + error);
                });
            });
        }
        
        // Configurar CEP do novo endereço
        const novoCepInput = document.getElementById('novo-endereco-cep');
        if (novoCepInput) {
            // Máscara de CEP
            novoCepInput.addEventListener('input', function(e) {
                let value = e.target.value.replace(/\D/g, '');
                if (value.length > 5) {
                    value = value.substring(0, 5) + '-' + value.substring(5, 8);
                }
                e.target.value = value;
            });
            
            // Busca automática no ViaCEP
            novoCepInput.addEventListener('blur', function() {
                const cep = this.value.replace(/\D/g, '');
                
                if (cep.length !== 8) {
                    return;
                }
                
                fetch(`https://viacep.com.br/ws/${cep}/json/`)
                    .then(response => response.json())
                    .then(data => {
                        if (!data.erro) {
                            document.getElementById('novo-endereco-logradouro').value = data.logradouro || '';
                            document.getElementById('novo-endereco-bairro').value = data.bairro || '';
                            document.getElementById('novo-endereco-cidade').value = data.localidade || '';
                            document.getElementById('novo-endereco-estado').value = data.uf || '';
                        }
                    })
                    .catch(error => {
                        console.error('Erro ao consultar CEP:', error);
                    });
            });
        }
    });
</script>
{% endblock %} 